@startuml
title Spring Boot 3.x Startup Process (Detailed)
skinparam backgroundColor #FFFFFF
skinparam handwritten false
skinparam ParticipantPadding 20
skinparam BoxPadding 10

participant "Main Application" as App
participant SpringApplication
participant ApplicationProperties
participant WebApplicationType
participant SpringFactoriesLoader
participant DefaultBootstrapContext
participant SpringApplicationRunListener
participant SpringApplicationBannerPrinter
participant ApplicationContextFactory
participant ApplicationContextInitializer
participant ApplicationContext
participant BeanFactory
participant AutoConfiguration
participant SpringApplicationRunListeners

App -> SpringApplication: SpringApplication.run(Class<?> primarySource, String... args)

== Create a new SpringApplication instance ==

activate SpringApplication
SpringApplication -> SpringApplication: new SpringApplication(Class<?> primarySource)
activate SpringApplication #FFBBBB

SpringApplication -> ApplicationProperties: new ApplicationProperties()
activate ApplicationProperties
return properties
deactivate ApplicationProperties

SpringApplication -> WebApplicationType: deduceFromClasspath()
activate SpringApplication #87CEEB
activate WebApplicationType
return WebApplicationType
deactivate WebApplicationType

SpringApplication -> ApplicationProperties: setWebApplicationType()
activate ApplicationProperties
note right: Internal property setting:\nthis.webApplicationType = type
ApplicationProperties --> SpringApplication
deactivate ApplicationProperties
deactivate SpringApplication

SpringApplication -> SpringApplication: getSpringFactoriesInstances(BootstrapRegistryInitializer.class)
activate SpringApplication #87CEEB
SpringApplication -> SpringFactoriesLoader: load()
note right: Load and instantiate the factory implementations of BootstrapRegistryInitializer from "META-INF/spring.factories"
activate SpringFactoriesLoader
return a list of BootstrapRegistryInitializer
note right: BootstrapRegistryInitializer is a powerful tool for early initialization and configuration in Spring Boot applications, \nespecially when you need to set up components before the main application context is created.
deactivate SpringFactoriesLoader
deactivate SpringApplication

SpringApplication -> SpringApplication: getSpringFactoriesInstances(ApplicationContextInitializer.class)
activate SpringApplication #87CEEB
SpringApplication -> SpringFactoriesLoader: load()
note right: Load and instantiate the factory implementations of ApplicationContextInitializer from "META-INF/spring.factories"
activate SpringFactoriesLoader
return a list of ApplicationContextInitializer
note right: ApplicationContextInitializer is a powerful tool for customizing the Spring application context during its initialization phase.
deactivate SpringFactoriesLoader
deactivate SpringApplication

SpringApplication -> SpringApplication: getSpringFactoriesInstances(ApplicationListener.class)
activate SpringApplication #87CEEB
SpringApplication -> SpringFactoriesLoader: load()
note right: Load and instantiate the factory implementations of ApplicationListener from "META-INF/spring.factories"
activate SpringFactoriesLoader
return a list of ApplicationListener
note right: ApplicationListener is a powerful tool for handling various types of events in Spring Boot applications, \nenabling loose coupling and flexible event-driven architectures.
deactivate SpringFactoriesLoader
deactivate SpringApplication
deactivate SpringApplication

== Run the Spring application, creating and refreshing a new ApplicationContext ==

SpringApplication -> SpringApplication: run(String... args)
activate SpringApplication #98FB98

SpringApplication -> SpringApplication: createBootstrapContext()
activate SpringApplication #87CEEB
SpringApplication -> DefaultBootstrapContext: new DefaultBootstrapContext()
activate DefaultBootstrapContext
return DefaultBootstrapContext
deactivate DefaultBootstrapContext
deactivate SpringApplication

SpringApplication -> SpringApplication: getRunListeners()
activate SpringApplication #87CEEB
SpringApplication -> SpringApplication: getSpringFactoriesInstances(SpringApplicationRunListener.class)
SpringApplication -> SpringFactoriesLoader: load()
note right: Load and instantiate the factory implementations of SpringApplicationRunListener from "META-INF/spring.factories"
activate SpringFactoriesLoader
return a list of SpringApplicationRunListener
note right: SpringApplicationRunListener is a powerful tool for monitoring and customizing the Spring Boot application startup process.
deactivate SpringFactoriesLoader
deactivate SpringApplication

SpringApplication -[#FF8C00]> SpringApplicationRunListeners: <font color="#FF8C00">starting()</font>
activate SpringApplicationRunListeners
SpringApplicationRunListeners --[#FF8C00]> SpringApplication
deactivate SpringApplicationRunListeners

SpringApplication -> SpringApplication: prepareEnvironment()
activate SpringApplication #DarkSalmon
SpringApplication -> SpringApplication: getOrCreateEnvironment()
SpringApplication -> ApplicationContextFactory: createEnvironment()
activate ApplicationContextFactory
ApplicationContextFactory --> SpringApplication: ConfigurableEnvironment
deactivate ApplicationContextFactory
SpringApplication -> SpringApplication: configureEnvironment()
SpringApplication -[#FF8C00]> SpringApplicationRunListeners: <font color="#FF8C00">environmentPrepared()</font>
activate SpringApplicationRunListeners
SpringApplicationRunListeners --[#FF8C00]> SpringApplication
deactivate SpringApplicationRunListeners
SpringApplication -> SpringApplication: bindToSpringApplication()
deactivate SpringApplication

SpringApplication -> SpringApplication: printBanner()
activate SpringApplication #87CEEB
SpringApplication -> SpringApplicationBannerPrinter: print()
activate SpringApplicationBannerPrinter
SpringApplicationBannerPrinter --> SpringApplication
deactivate SpringApplicationBannerPrinter
deactivate SpringApplication

SpringApplication -> SpringApplication: createApplicationContext()
activate SpringApplication #87CEEB
SpringApplication -> ApplicationContextFactory: create()
activate ApplicationContextFactory
ApplicationContextFactory --> SpringApplication: ConfigurableApplicationContext
deactivate ApplicationContextFactory
deactivate SpringApplication

SpringApplication -> SpringApplication: prepareContext()
activate SpringApplication #FFB6C1
SpringApplication -> ApplicationContext: setEnvironment()
SpringApplication -> ApplicationContext: postProcessApplicationContext()
SpringApplication -> ApplicationContextInitializer: initialize(context)
activate ApplicationContextInitializer
ApplicationContextInitializer --> SpringApplication
deactivate ApplicationContextInitializer
SpringApplication -[#FF8C00]> SpringApplicationRunListeners: <font color="#FF8C00">contextPrepared()</font>
activate SpringApplicationRunListeners
SpringApplicationRunListeners --[#FF8C00]> SpringApplication
deactivate SpringApplicationRunListeners
deactivate SpringApplication

SpringApplication -> SpringApplication: refreshContext()
activate SpringApplication #FFD700
SpringApplication -> ApplicationContext: refresh()
activate ApplicationContext

ApplicationContext -> BeanFactory: prepareBeanFactory()
activate BeanFactory
BeanFactory --> ApplicationContext
deactivate BeanFactory

ApplicationContext -> AutoConfiguration: processAutoConfiguration()
activate AutoConfiguration
AutoConfiguration --> ApplicationContext
deactivate AutoConfiguration

ApplicationContext -> ApplicationContext: finishBeanFactoryInitialization()
activate ApplicationContext #98FB98
ApplicationContext -> ApplicationContext: preInstantiateSingletons()
deactivate ApplicationContext

ApplicationContext --> SpringApplication
deactivate ApplicationContext
deactivate SpringApplication

SpringApplication -> SpringApplication: afterRefresh()
activate SpringApplication #B0E0E6
SpringApplication -[#FF8C00]> SpringApplicationRunListeners: <font color="#FF8C00">started()</font>
activate SpringApplicationRunListeners
SpringApplicationRunListeners --[#FF8C00]> SpringApplication
deactivate SpringApplicationRunListeners
SpringApplication -[#FF8C00]> SpringApplicationRunListeners: <font color="#FF8C00">running()</font>
activate SpringApplicationRunListeners
SpringApplicationRunListeners --[#FF8C00]> SpringApplication
deactivate SpringApplicationRunListeners
deactivate SpringApplication

SpringApplication --> App: return ApplicationContext
deactivate SpringApplication

@enduml

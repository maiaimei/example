@startuml Spring Boot 3.4.4 应用启动流程

' https://plantuml.com/zh/sequence-diagram

title Spring Boot 3.4.4 应用启动流程

!theme plain

' ========================================
' 参与者定义 - Spring Boot启动涉及的核心组件
' ========================================
participant "开发者" as Developer
participant SpringApplication
participant SpringApplicationRunListeners
participant DefaultApplicationContextFactory
participant AnnotationConfigServletWebServerApplicationContext
participant AnnotatedBeanDefinitionReader
participant AnnotationConfigUtils
participant ClassPathBeanDefinitionScanner
participant ConfigurableApplicationContext
participant AbstractApplicationContext
participant ConfigurableBeanFactory
participant BeanFactory
participant SingletonBeanRegistry
participant WebServer

' ========================================
' 启动入口 - SpringApplication.run()静态方法
' 这是Spring Boot应用的标准启动方式
' ========================================
Developer -> SpringApplication: run(primarySource, args)
activate SpringApplication

note over SpringApplication: 静态方法调用：new SpringApplication(primarySources).run(args)
note right of SpringApplication: primarySources通常是@SpringBootApplication注解的主类

' ========================================
' 阶段1：SpringApplication实例构造
' 初始化SpringApplication实例的关键属性
' ========================================
group new SpringApplication(primarySources)
    SpringApplication -> SpringApplication: 推断应用类型(Servlet/Reactive/None)\nthis.webApplicationType = WebApplicationType.deduceFromClasspath();
    note right
    根据classpath中的类判断应用类型：
    - SERVLET: 传统Web应用
    - REACTIVE: WebFlux响应式应用
    - NONE: 非Web应用
    end note
    
    SpringApplication -> SpringApplication: setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));
    note right
    从META-INF/spring.factories加载ApplicationContextInitializer实例
    用于自定义初始化ApplicationContext
    end note
    
    SpringApplication -> SpringApplication: setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));
    note right
    从META-INF/spring.factories加载ApplicationListener实例
    用于监听应用事件
    end note
end

' ========================================
' 阶段2：应用启动执行 - run(args)方法核心逻辑
' Spring Boot启动的9个关键步骤
' ========================================
group run(args)
    ' 获取运行时监听器
    SpringApplication -> SpringApplication: getRunListeners()
    note right
    从META-INF/spring.factories加载SpringApplicationRunListener实例。
    SpringApplicationRunListener接口用于监听Spring Boot应用启动过程中的各个关键阶段，
    允许开发者在不同时间点插入自定义逻辑。
    用于在启动过程中发布事件。
    end note

    ' ========================================
    ' 启动监听器通知 - starting事件
    ' 标志着Spring Boot应用开始启动
    ' ========================================
    SpringApplication -> SpringApplicationRunListeners: starting()
    note right: 通知所有注册的SpringApplicationRunListener实例应用启动开始\n可用于执行预启动逻辑，此时应用环境、上下文等均未初始化，适合在最早期进行准备工作
    activate SpringApplicationRunListeners
    SpringApplicationRunListeners --> SpringApplication:
    deactivate SpringApplicationRunListeners

    ' ========================================
    ' 环境准备 - 配置Environment
    ' 创建和配置ConfigurableEnvironment实例
    ' ========================================
    SpringApplication -> SpringApplication: prepareEnvironment()
    note right: Spring Boot启动过程中负责创建和配置应用环境的核心方法
    activate SpringApplication
        SpringApplication -> SpringApplication: getOrCreateEnvironment()
        activate SpringApplication
        SpringApplication -> DefaultApplicationContextFactory: createEnvironment()
        note right: 根据webApplicationType创建对应的Environment实现\n- StandardServletEnvironment\n- StandardReactiveEnvironment\n- StandardEnvironment
        activate DefaultApplicationContextFactory
        DefaultApplicationContextFactory --> SpringApplication: ConfigurableEnvironment
        deactivate DefaultApplicationContextFactory
        deactivate SpringApplication
        
        SpringApplication -> SpringApplication: configureEnvironment(environment, applicationArguments.getSourceArgs())
        note right: 配置属性源优先级：\n1. 命令行参数\n2. 系统属性\n3. 环境变量\n4. application.properties/yml

        SpringApplication -> SpringApplication: ConfigurationPropertySources.attach(environment)
        note right: 将配置属性源附加到环境中，确保属性源处于正确位置
        
        SpringApplication -> SpringApplicationRunListeners: environmentPrepared()
        note right: 通知监听器Environment已准备好\n可用于修改环境属性\n当环境配置准备完成、但应用上下文尚未创建时触发，可用于对环境进行自定义修改
        activate SpringApplicationRunListeners
        SpringApplicationRunListeners --> SpringApplication:
        deactivate SpringApplicationRunListeners
    deactivate SpringApplication

    ' 打印Banner
    SpringApplication -> SpringApplication: printBanner(environment)
    note right: 打印Spring Boot启动横幅\n可通过spring.banner.location自定义

    ' ========================================
    ' 创建应用上下文 - ApplicationContext
    ' 根据应用类型创建对应的上下文实现
    ' ========================================
    SpringApplication -> SpringApplication: createApplicationContext()
    activate SpringApplication
        SpringApplication --> DefaultApplicationContextFactory: create(WebApplicationType webApplicationType)
        note right: 根据webApplicationType创建对应的ApplicationContext实现\n- SERVLET: AnnotationConfigServletWebServerApplicationContext\n- REACTIVE: AnnotationConfigReactiveWebServerApplicationContext\n- NONE: AnnotationConfigApplicationContext
        activate DefaultApplicationContextFactory

        DefaultApplicationContextFactory -> AnnotationConfigServletWebServerApplicationContext: new AnnotationConfigServletWebServerApplicationContext()
        note right: 创建AnnotationConfigServletWebServerApplicationContext实例\n适用于SERVLET类型的Web应用
        activate AnnotationConfigServletWebServerApplicationContext

        AnnotationConfigServletWebServerApplicationContext -> AnnotatedBeanDefinitionReader: new AnnotatedBeanDefinitionReader(this) 
        activate AnnotatedBeanDefinitionReader

        AnnotatedBeanDefinitionReader -> AnnotationConfigUtils: registerAnnotationConfigProcessors(this.registry)
        activate AnnotationConfigUtils
        note right
        注册后处理器：
        - ConfigurationClassPostProcessor: 处理@Configuration类
        - AutowiredAnnotationBeanPostProcessor: 处理@Autowired注解
        - CommonAnnotationBeanPostProcessor: 处理@Resource等注解
        注册工具Bean：
        - EventListenerMethodProcessor: 处理@EventListener注解
        - DefaultEventListenerFactory: 事件监听器工厂
        end note
        AnnotationConfigUtils --> AnnotatedBeanDefinitionReader:
        deactivate AnnotationConfigUtils

        AnnotatedBeanDefinitionReader --> AnnotationConfigServletWebServerApplicationContext: AnnotatedBeanDefinitionReader
        deactivate AnnotatedBeanDefinitionReader
        
        AnnotationConfigServletWebServerApplicationContext --> DefaultApplicationContextFactory:
        deactivate AnnotationConfigServletWebServerApplicationContext
        
        DefaultApplicationContextFactory --> SpringApplication: ConfigurableApplicationContext
        deactivate DefaultApplicationContextFactory
    deactivate SpringApplication

    ' ========================================
    ' 上下文准备 - prepareContext
    ' 配置ApplicationContext的基本属性
    ' ========================================
    SpringApplication -> SpringApplication: prepareContext()
    activate SpringApplication
        SpringApplication -> ConfigurableApplicationContext: setEnvironment(environment)
        note right: 将Environment设置到ApplicationContext
        activate ConfigurableApplicationContext
        ConfigurableApplicationContext --> SpringApplication:
        deactivate ConfigurableApplicationContext

        SpringApplication -> SpringApplication: postProcessApplicationContext(context)
        note right: 对ApplicationContext进行后处理\n如注册特定的Bean定义

        SpringApplication -> SpringApplication: applyInitializers(context)
        note right: 执行所有ApplicationContextInitializer\n对ApplicationContext进行自定义初始化

        SpringApplication -> SpringApplicationRunListeners: contextPrepared(context)
        note right: 通知监听器ApplicationContext已准备好\n可用于注册Bean定义或修改上下文配置\n在应用上下文构建完成、但尚未加载Bean定义前调用，适合对上下文进行早期配置
        activate SpringApplicationRunListeners
        SpringApplicationRunListeners --> SpringApplication:
        deactivate SpringApplicationRunListeners

        SpringApplication -> SingletonBeanRegistry: registerSingleton("springApplicationArguments", applicationArguments)
        note right: 注册springApplicationArguments单例Bean\n用于在应用中访问启动参数
        activate SingletonBeanRegistry
        SingletonBeanRegistry --> SpringApplication:
        deactivate SingletonBeanRegistry

        SpringApplication -> ConfigurableApplicationContext: addBeanFactoryPostProcessor(new PropertySourceOrderingBeanFactoryPostProcessor(context))
        note right: 注册BeanFactoryPostProcessor\n确保属性源按优先级排序
        activate ConfigurableApplicationContext
        ConfigurableApplicationContext --> SpringApplication:
        deactivate ConfigurableApplicationContext
        
        SpringApplication -> SpringApplicationRunListeners: contextLoaded(context)
        note right: 通知监听器ApplicationContext已加载\n可用于在Bean实例化前进行最后的修改\n在应用上下文加载完所有Bean定义后、但尚未实例化任何Bean前调用，适合对Bean定义进行最终调整
        activate SpringApplicationRunListeners
        SpringApplicationRunListeners --> SpringApplication:
        deactivate SpringApplicationRunListeners
    deactivate SpringApplication

    ' ========================================
    ' 刷新上下文 - refresh()核心阶段
    ' Spring容器的核心初始化过程
    ' ========================================
    SpringApplication -> SpringApplication: refreshContext()
    activate SpringApplication
    
        SpringApplication -> AbstractApplicationContext: refresh()
        activate AbstractApplicationContext
        
            ' 准备刷新 - 设置启动时间，激活标志
            AbstractApplicationContext -> AbstractApplicationContext: prepareRefresh()
            note right: 设置容器启动时间\n初始化属性源\n验证必需属性
            
            ' 获取BeanFactory - 通知子类刷新内部的Bean工厂
            AbstractApplicationContext -> AbstractApplicationContext: obtainFreshBeanFactory()
            note right: 通知子类刷新内部的Bean工厂
            
            ' 准备BeanFactory - 配置工厂的标准上下文特性，例如上下文的类加载器和后处理器。
            AbstractApplicationContext -> AbstractApplicationContext: prepareBeanFactory()
            note right: 设置ClassLoader\n添加BeanPostProcessor\n注册默认环境Bean
            activate AbstractApplicationContext

            AbstractApplicationContext -> ConfigurableBeanFactory: addBeanPostProcessor(new ApplicationContextAwareProcessor(this))
            activate ConfigurableBeanFactory
            ConfigurableBeanFactory --> AbstractApplicationContext:
            deactivate ConfigurableBeanFactory

            AbstractApplicationContext -> ConfigurableBeanFactory: addBeanPostProcessor(new ApplicationListenerDetector(this))
            activate ConfigurableBeanFactory
            ConfigurableBeanFactory --> AbstractApplicationContext:
            deactivate ConfigurableBeanFactory            

            deactivate AbstractApplicationContext
            
            ' 5.4 后处理BeanFactory - 子类扩展点
            AbstractApplicationContext -> AbstractApplicationContext: postProcessBeanFactory()
            note right: 允许子类对BeanFactory进行\n进一步的设置和修改
            
            ' 5.5 调用BeanFactory后处理器 - 执行BFPP
            AbstractApplicationContext -> AbstractApplicationContext: invokeBeanFactoryPostProcessors()
            note right: 执行BeanFactoryPostProcessor\n包括ConfigurationClassPostProcessor\n处理@Configuration类
            
            ' 5.6 注册Bean后处理器 - 注册BPP
            AbstractApplicationContext -> AbstractApplicationContext: registerBeanPostProcessors()
            note right: 注册BeanPostProcessor\n用于Bean实例化后的处理\n如@Autowired注入
            
            ' 5.7 初始化消息源 - 国际化支持
            AbstractApplicationContext -> AbstractApplicationContext: initMessageSource()
            note right: 初始化MessageSource\n支持国际化消息
            
            ' 5.8 初始化事件多播器 - 事件发布机制
            AbstractApplicationContext -> AbstractApplicationContext: initApplicationEventMulticaster()
            note right: 初始化ApplicationEventMulticaster\n用于发布ApplicationEvent
            
            ' 5.9 刷新特定上下文 - 启动Web服务器（关键步骤）
            AbstractApplicationContext -> AbstractApplicationContext: onRefresh()
            activate AbstractApplicationContext
                AbstractApplicationContext -> WebServer: 创建和启动内嵌Web服务器
                activate WebServer
                WebServer --> AbstractApplicationContext:
                deactivate WebServer
            deactivate AbstractApplicationContext
            note right: Web应用的关键步骤\n创建Tomcat/Jetty/Undertow\n启动HTTP服务器
            
            ' 5.10 注册监听器 - 注册事件监听器
            AbstractApplicationContext -> AbstractApplicationContext: registerListeners()
            note right: 注册ApplicationListener\n发布早期事件
            
            ' 5.11 完成BeanFactory初始化 - 实例化单例Bean
            AbstractApplicationContext -> AbstractApplicationContext: finishBeanFactoryInitialization()
            note right: 实例化所有非懒加载的单例Bean\n这是最耗时的步骤
            
            ' 5.12 完成刷新 - 发布刷新完成事件
            AbstractApplicationContext -> AbstractApplicationContext: finishRefresh()
            note right: 清理资源缓存\n发布ContextRefreshedEvent\n启动Lifecycle Bean
        
        AbstractApplicationContext --> SpringApplication:
        deactivate AbstractApplicationContext
    
    deactivate SpringApplication

    ' ========================================
    ' 步骤6：启动完成通知 - started事件
    ' ApplicationContext已完全启动
    ' ========================================
    SpringApplication -> SpringApplicationRunListeners: started(context)
    activate SpringApplicationRunListeners
    SpringApplicationRunListeners --> SpringApplication:
    deactivate SpringApplicationRunListeners
    
    ' ========================================
    ' 步骤7：执行Runner - 应用启动后回调
    ' 执行用户自定义的启动逻辑
    ' ========================================
    SpringApplication -> SpringApplication: callRunners(context, applicationArguments)
    activate SpringApplication
        SpringApplication -> SpringApplication: 执行ApplicationRunner和CommandLineRunner
        note right: 按@Order排序执行\nApplicationRunner接收ApplicationArguments\nCommandLineRunner接收String[]参数
    deactivate SpringApplication
    
    ' ========================================
    ' 步骤8：就绪通知 - ready事件
    ' 应用完全启动并准备接收请求
    ' ========================================
    SpringApplication -> SpringApplicationRunListeners: ready(context)
    activate SpringApplicationRunListeners
    SpringApplicationRunListeners --> SpringApplication:
    deactivate SpringApplicationRunListeners
    
    ' ========================================
    ' 步骤9：启动完成
    ' Spring Boot应用启动流程结束
    ' ========================================
    SpringApplication -> SpringApplication: 启动完成
    note right: 启动耗时统计\n应用状态设置为RUNNING
end

' ========================================
' 返回结果 - 启动成功
' 返回可配置的ApplicationContext实例
' ========================================
SpringApplication --> Developer: 返回ConfigurableApplicationContext
deactivate SpringApplication
note left of Developer: 应用启动成功\n可通过返回的ApplicationContext\n获取Bean和管理应用生命周期

@enduml
